name: Build and Push Notification Service Docker to ECR

on:
  push:
    branches:
      - main

permissions:
  id-token: write
  contents: read

env:
  ECR_REPOSITORY: real-estate-notification-service
  AWS_REGION: us-east-1
  IMAGE_TAG: ${{ github.sha }}
  IMAGE_URI_SHA: 811329404514.dkr.ecr.us-east-1.amazonaws.com/real-estate-notification-service:${{ github.sha }}

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ Checkout code
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2️⃣ Configure AWS credentials via OIDC
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::811329404514:role/github-actions-oidc-role
          aws-region: ${{ env.AWS_REGION }}

      # 3️⃣ Fetch all env vars dynamically from AWS Secrets Manager
      - name: Fetch environment variables from AWS Secrets Manager
        id: secrets
        run: |
          if aws secretsmanager describe-secret --secret-id real-estate-notification-service-app > /dev/null 2>&1; then
            SECRET_JSON=$(aws secretsmanager get-secret-value \
              --secret-id real-estate-notification-service-app \
              --query SecretString --output text)

            # Loop through each key/value and export to GitHub Actions env
            for key in $(echo $SECRET_JSON | jq -r 'keys[]'); do
              value=$(echo $SECRET_JSON | jq -r --arg k "$key" '.[$k]')
              echo "$key=$value" >> $GITHUB_ENV
            done
          else
            echo "Secret real-estate-notification-service-app not found, skipping env var fetch"
          fi

      # 4️⃣ Login to Amazon ECR
      - name: Login to Amazon ECR
        run: |
          aws ecr get-login-password --region ${{ env.AWS_REGION }} | docker login \
            --username AWS \
            --password-stdin 811329404514.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com

      # 5️⃣ Build Docker image with all environment variables
      - name: Build Docker image
        run: |
          # Build args from environment variables
          BUILD_ARGS=""
          while IFS='=' read -r key value; do
            # Skip empty keys or lines that don't have a key
            if [[ -n "$key" && "$key" != "" ]]; then
              BUILD_ARGS="$BUILD_ARGS --build-arg $key=$value"
            fi
          done < "$GITHUB_ENV"

          echo "Building with args:"
          echo "$BUILD_ARGS"

          docker build $BUILD_ARGS \
            -t ${{ env.ECR_REPOSITORY }}:${{ env.IMAGE_TAG }} .

      # 6️⃣ Tag Docker image for ECR
      - name: Tag Docker image for ECR
        run: |
          docker tag ${{ env.ECR_REPOSITORY }}:${{ env.IMAGE_TAG }} \
            811329404514.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com/${{ env.ECR_REPOSITORY }}:${{ env.IMAGE_TAG }}

      # 7️⃣ Push Docker image to ECR
      - name: Push Docker image
        run: |
          docker push 811329404514.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com/${{ env.ECR_REPOSITORY }}:${{ env.IMAGE_TAG }}

      # Generate GitHub App token
      - name: Generate GitHub App Token
        id: app-token
        uses: tibdex/github-app-token@v2
        with:
          app_id: ${{ secrets.REAL_ESTATE_BOT_ID }}
          private_key: ${{ secrets.REAL_ESTATE_BOT_KEY }}

      # Trigger GitOps repo workflow
      - name: Trigger GitOps image update
        uses: peter-evans/repository-dispatch@v3
        with:
          token: ${{ steps.app-token.outputs.token }}
          repository: Real-Estate-Management-DevOps-Project/argocd
          event-type: update-image
          client-payload: |
            {
              "app": "notification-service",
              "image": "${{ env.IMAGE_URI_SHA }}"
            }
